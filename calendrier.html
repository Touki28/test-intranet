<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Calendrier de l'Akatsuki</title>

    <link rel="icon" type="image/png" href="img/Akatsuki-Logo.png"/>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<script>
    const SESSION_KEY = "intranet_auth_ok_v2";
    if(!sessionStorage.getItem(SESSION_KEY)){
        window.location.href = "login.html";
    }
</script>

<a href="secret.html" class="clickable-cloud" aria-label="Lien cach√© vers la base secr√®te"></a>

<header>
    <div class="header-content">
        <div class="header-text">
            <h1>Le Calendrier de l'Akatsuki</h1>
            <p>Les Douze Lunes du Nuage Rouge</p>
        </div>
        
    </div>
</header>

<main>
	<div class="controls">
    <select id="weekSelector" class="week-select"></select>
  </div>

  <div id="calendar"></div>

  <div class="nav-buttons">
    <button id="prevWeek">‚Üê Semaine pr√©c√©dente</button>
    <button id="nextWeek">Semaine suivante ‚Üí</button>
  </div>

  <script>
    let allEvents = [];
    let currentWeekIndex = 0;
    let weeks = [];

    fetch('emploi.ics')
      .then(r => r.text())
      .then(parseICS)
      .catch(err => console.error('Erreur de chargement du fichier ICS:', err));

    function parseICS(content) {
      const lines = content.split(/\r?\n/);
      let events = [];
      let currentEvent = null;

      for (let line of lines) {
        line = line.trim();

        if (line === 'BEGIN:VEVENT') {
          currentEvent = {};
        } else if (line === 'END:VEVENT') {
          if (currentEvent && currentEvent.start) events.push(currentEvent);
          currentEvent = null;
        } else if (currentEvent) {
          if (line.startsWith('DTSTART')) currentEvent.start = parseICSDate(line);
          else if (line.startsWith('DTEND')) currentEvent.end = parseICSDate(line);
          else if (line.startsWith('SUMMARY')) currentEvent.summary = line.split(':')[1];
          else if (line.startsWith('LOCATION')) currentEvent.location = line.split(':')[1];
          else if (line.startsWith('DESCRIPTION')) currentEvent.description = line.split(':')[1];
        }
      }

      allEvents = events.sort((a, b) => a.start - b.start);
      initWeeks();
    }

    function parseICSDate(line) {
      const [meta, value] = line.split(':');
      if (!value) return null;

      if (value.endsWith('Z')) {
        const year = +value.slice(0, 4);
        const month = +value.slice(4, 6) - 1;
        const day = +value.slice(6, 8);
        const hour = +value.slice(9, 11);
        const minute = +value.slice(11, 13);
        return new Date(Date.UTC(year, month, day, hour, minute));
      }

      if (meta.includes('TZID=Europe/Paris')) {
        const year = +value.slice(0, 4);
        const month = +value.slice(4, 6) - 1;
        const day = +value.slice(6, 8);
        const hour = +value.slice(9, 11);
        const minute = +value.slice(11, 13);
        return new Date(year, month, day, hour, minute);
      }

      const year = +value.slice(0, 4);
      const month = +value.slice(4, 6) - 1;
      const day = +value.slice(6, 8);
      const hour = +value.slice(9, 11);
      const minute = +value.slice(11, 13);
      return new Date(year, month, day, hour, minute);
    }

    function initWeeks() {
      weeks = [...new Set(allEvents.map(ev => getWeekNumber(ev.start)))].sort((a, b) => a - b);
      const selector = document.getElementById('weekSelector');
      selector.innerHTML = weeks.map(w => `<option value="${w}">Semaine ${w}</option>`).join('');
      selector.addEventListener('change', () => showWeek(parseInt(selector.value)));
      showWeek(weeks[0]);
    }

    function getWeekNumber(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      const yearStart = new Date(d.getFullYear(), 0, 1);
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function showWeek(weekNum) {
      currentWeekIndex = weeks.indexOf(weekNum);
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      const weekEvents = allEvents.filter(ev => getWeekNumber(ev.start) === weekNum);
      const grouped = {};
      weekEvents.forEach(ev => {
        const key = ev.start.toLocaleDateString('fr-FR');
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(ev);
      });

      for (const [day, events] of Object.entries(grouped)) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day';

        const header = document.createElement('div');
        header.className = 'day-header';
        const dateObj = new Date(events[0].start);
        header.innerHTML = `
          <div>${dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })}</div>
          <span>${events.length} cours</span>
        `;
        dayDiv.appendChild(header);

        events.forEach(ev => {
          const eDiv = document.createElement('div');
          eDiv.className = 'event';
          eDiv.innerHTML = `
            <div class="event-time">${formatTime(ev.start)} - ${formatTime(ev.end)}</div>
            <div class="event-subject">${ev.summary || 'Cours'}</div>
            ${ev.location ? `<div class="event-details">üìç ${ev.location}</div>` : ''}
          `;
          dayDiv.appendChild(eDiv);
        });

        calendar.appendChild(dayDiv);
      }

      document.getElementById('weekSelector').value = weekNum;
    }

    document.getElementById('prevWeek').addEventListener('click', () => {
      if (currentWeekIndex > 0) showWeek(weeks[currentWeekIndex - 1]);
    });

    document.getElementById('nextWeek').addEventListener('click', () => {
      if (currentWeekIndex < weeks.length - 1) showWeek(weeks[currentWeekIndex + 1]);
    });

    function formatTime(date) {
      return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }
  </script>
</main>

<div class="home-btn-container">
    <button onclick="window.location.href='index.html';">
        Accueil de l'Intranet
    </button>
</div>

<footer>
    <p>&copy; 2025 Akakatsuki Intranet </p>
</footer>
</body>
</html>