<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Calendrier de l'Akatsuki</title>

    <link rel="icon" type="image/png" href="img/Akatsuki-Logo.png"/>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<script>
    const SESSION_KEY = "intranet_auth_ok_v2";
    if(!sessionStorage.getItem(SESSION_KEY)){
        window.location.href = "login.html";
    }
</script>

<a href="secret.html" class="clickable-cloud" aria-label="Lien caché vers la base secrète"></a>

<header>
    <div class="header-content">
        <div class="header-text">
            <h1>Le Calendrier de l'Akatsuki</h1>
            <p>Les Douze Lunes du Nuage Rouge</p>
        </div>
        
    </div>
</header>

<main>
    <div class="controls">
    <button id="prevWeek">◀ Semaine précédente</button>
    <span class="week-label" id="weekLabel"></span>
    <button id="nextWeek">Semaine suivante ▶</button>
  </div>
  <div id="calendar"></div>

  <script>
    async function loadICS() {
      const res = await fetch('emploi.ics');
      const icsText = await res.text();
      const events = parseICS(icsText);
      return events.sort((a, b) => a.start - b.start);
    }

    function parseICS(text) {
      const lines = text.split('\n');
      const events = [];
      let current = null;

      for (let line of lines) {
        line = line.trim();
        if (line === 'BEGIN:VEVENT') {
          current = {};
        } else if (line === 'END:VEVENT' && current) {
          if (current.start && current.summary) events.push(current);
          current = null;
        } else if (current) {
          if (line.startsWith('DTSTART')) current.start = parseICSDate(line.split(':')[1]);
          if (line.startsWith('DTEND')) current.end = parseICSDate(line.split(':')[1]);
          if (line.startsWith('SUMMARY')) current.summary = line.split(':')[1];
          if (line.startsWith('LOCATION')) current.location = line.split(':')[1];
        }
      }
      return events;
    }

    function parseICSDate(str) {
      const year = +str.substring(0, 4);
      const month = +str.substring(4, 6) - 1;
      const day = +str.substring(6, 8);
      const hour = +str.substring(9, 11);
      const minute = +str.substring(11, 13);
      return new Date(year, month, day, hour, minute);
    }

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function groupByDay(events) {
      const grouped = {};
      for (const ev of events) {
        const key = ev.start.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(ev);
      }
      return grouped;
    }

    function displayWeek(events, week) {
      const container = document.getElementById('calendar');
      container.innerHTML = '';
      const filtered = events.filter(e => getWeekNumber(e.start) === week);
      const grouped = groupByDay(filtered);

      document.getElementById('weekLabel').textContent = 'Semaine ' + week;

      for (const [day, evs] of Object.entries(grouped)) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day';
        const title = document.createElement('h2');
        title.textContent = day;
        dayDiv.appendChild(title);

        for (const ev of evs) {
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event';
          eventDiv.innerHTML = `
            <div class="time">${ev.start.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})} 
              - ${ev.end.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</div>
            <div class="summary">${ev.summary}</div>
            ${ev.location ? `<div class="location">${ev.location}</div>` : ''}
          `;
          dayDiv.appendChild(eventDiv);
        }

        container.appendChild(dayDiv);
      }
    }

    let allEvents = [];
    let currentWeek = null;

    loadICS().then(events => {
      allEvents = events;
      if (events.length > 0) {
        currentWeek = getWeekNumber(events[0].start);
        displayWeek(allEvents, currentWeek);
      }
    });

    document.getElementById('prevWeek').addEventListener('click', () => {
      currentWeek--;
      displayWeek(allEvents, currentWeek);
    });

    document.getElementById('nextWeek').addEventListener('click', () => {
      currentWeek++;
      displayWeek(allEvents, currentWeek);
    });
  </script>
</main>

<div class="home-btn-container">
    <button onclick="window.location.href='index.html';">
        Accueil de l'Intranet
    </button>
</div>

<footer>
    <p>&copy; 2025 Akakatsuki Intranet </p>
</footer>
</body>
</html>